name: Sync Nucleo Evolution Data

on:
  schedule:
    # Ogni 6 ore
    - cron: '0 */6 * * *'
  
  # Manuale on-demand
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create data directories
        run: |
          mkdir -p _data/nucleo_detail
          mkdir -p _data/language_detail
          echo "ðŸ“ Directories created"
      
      - name: Fetch Dashboard
        run: |
          echo "ðŸ“¥ Fetching dashboard..."
          curl -f -v https://log-puck.org/nucleo/nucleo_publish/dashboard.json \
               -o _data/nucleo_dashboard.json
          
          echo "âœ… Dashboard downloaded"
          ls -lh _data/nucleo_dashboard.json
          echo "Preview:"
          head -n 10 _data/nucleo_dashboard.json
      
      - name: Fetch Nucleo Details
        run: |
          # Get list of nuclei from dashboard
          NUCLEI=$(jq -r '.by_nucleo[].nucleo_id' _data/nucleo_dashboard.json)
          
          echo "ðŸ“¥ Fetching details for nuclei: $NUCLEI"
          
          # Fetch each nucleo detail
          for nucleo in $NUCLEI; do
            echo "  â†’ $nucleo"
            if curl -f "https://log-puck.org/nucleo/nucleo_publish/detail/${nucleo}.json" \
                    -o "_data/nucleo_detail/${nucleo}.json"; then
              echo "    âœ… Success"
            else
              echo "    âŒ Failed"
            fi
          done
          
          echo "Files downloaded:"
          ls -lh _data/nucleo_detail/
      
      - name: Fetch Language Details
        run: |
          echo "ðŸ“¥ Fetching language details..."
          
          # Fetch each language detail using while read to preserve spaces
          jq -r '.summary.languages[]' _data/nucleo_dashboard.json | while IFS= read -r lang; do
            # Sanitize for filename
            lang_sanitized=$(echo "$lang" | sed 's/ /_/g' | tr '[:upper:]' '[:lower:]')
            
            echo "  â†’ '$lang' â†’ ${lang_sanitized}.json"
            
            # Try downloading with sanitized name first
            if curl -f "https://log-puck.org/nucleo/nucleo_publish/language/${lang_sanitized}.json" \
                    -o "_data/language_detail/${lang_sanitized}.json" 2>/dev/null; then
              echo "    âœ… Success (sanitized URL)"
            # If that fails, try with original name and save as sanitized
            elif curl -f "https://log-puck.org/nucleo/nucleo_publish/language/${lang}.json" \
                    -o "_data/language_detail/${lang_sanitized}.json" 2>/dev/null; then
              echo "    âœ… Success (original URL)"
            else
              echo "    âŒ Failed both attempts"
            fi
          done
          
          echo "Files downloaded:"
          ls -lh _data/language_detail/
      
      - name: Check git status
        run: |
          echo "ðŸ“Š Git status:"
          git status
          
          echo ""
          echo "ðŸ“ Changed files:"
          git status --short
      
      - name: Generate Nucleo pages
        run: |
          echo "ðŸ”¬ Generating nucleo markdown files..."
          
          # Create evolution/nucleo directory if not exists
          mkdir -p waw/evolution/nucleo
          
          # Clean up old generated files (keep .gitkeep and _*.md test files)
          echo "Cleaning up old generated files..."
          find waw/evolution/nucleo -type f -name "*.md" ! -name "_*.md" -delete 2>/dev/null || true
          
          # Get list of nuclei from dashboard
          NUCLEI=$(jq -r '.by_nucleo[].nucleo_id' _data/nucleo_dashboard.json)
          
          # Generate .md file for each nucleo
          for nucleo in $NUCLEI; do
            echo "  â†’ Creating waw/evolution/nucleo/${nucleo}.md"
            
            # Write frontmatter using printf (safer than here-document in YAML)
            printf '%s\n' \
              "---" \
              "layout: nucleo_detail" \
              "nucleo_id: ${nucleo}" \
              "section: wAw" \
              "subsection: Evolution" \
              "permalink: /waw/evolution/nucleo/${nucleo}/" \
              "title: \"${nucleo}\"" \
              "---" \
              > "waw/evolution/nucleo/${nucleo}.md"
          done
          
          # Count generated files
          FILE_COUNT=$(ls -1 waw/evolution/nucleo/*.md 2>/dev/null | wc -l)
          echo "âœ… Generated ${FILE_COUNT} nucleo pages"
          
          # List generated files for verification
          echo "Files created:"
          ls -1 waw/evolution/nucleo/*.md 2>/dev/null || echo "  (none)"
      
      - name: Generate Language pages
        run: |
          echo "ðŸ—£ï¸ Generating language markdown files..."
          
          # Create evolution/language directory if not exists
          mkdir -p waw/evolution/language
          
          # Clean up old generated files (keep .gitkeep and _*.md test files)
          echo "Cleaning up old generated files..."
          find waw/evolution/language -type f -name "*.md" ! -name "_*.md" -delete 2>/dev/null || true
          
          # Generate .md file for each language using while read to preserve spaces
          jq -r '.summary.languages[]' _data/nucleo_dashboard.json | while IFS= read -r lang; do
            # Sanitize language name for filename (lowercase, spaces to underscores)
            lang_key=$(echo "$lang" | sed 's/ /_/g' | tr '[:upper:]' '[:lower:]')
            
            echo "  â†’ Creating waw/evolution/language/${lang_key}.md (from: '$lang')"
            
            # Write frontmatter using printf (safer than here-document in YAML)
            printf '%s\n' \
              "---" \
              "layout: language_detail" \
              "language_key: ${lang_key}" \
              "section: wAw" \
              "subsection: Evolution" \
              "permalink: /waw/evolution/language/${lang_key}/" \
              "title: \"${lang}\"" \
              "---" \
              > "waw/evolution/language/${lang_key}.md"
          done
          
          # Count generated files
          FILE_COUNT=$(ls -1 waw/evolution/language/*.md 2>/dev/null | wc -l)
          echo "âœ… Generated ${FILE_COUNT} language pages"
          
          # List generated files for verification
          echo "Files created:"
          ls -1 waw/evolution/language/*.md 2>/dev/null || echo "  (none)"
      
      - name: Commit and push
        run: |
          git config user.name "Nucleo Sync Bot"
          git config user.email "nucleo@log-puck.org"
          
          # Add all files (new and modified)
          git add _data/nucleo_dashboard.json
          git add _data/nucleo_detail/
          git add _data/language_detail/
          git add waw/evolution/nucleo/
          git add waw/evolution/language/
          
          # Check if there's anything to commit
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ðŸ”¬ Nucleo data sync - ${TIMESTAMP}"
            git push
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Summary
        run: |
          echo "### ðŸ”¬ Nucleo Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_data/nucleo_dashboard.json" ]; then
            TOTAL=$(jq -r '.summary.total_experiments' _data/nucleo_dashboard.json)
            NUCLEI=$(jq -r '.summary.unique_nuclei' _data/nucleo_dashboard.json)
            echo "**Experiments:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "**Nuclei:** $NUCLEI" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files synced:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Nuclei Details: $(ls _data/nucleo_detail/ 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Language Details: $(ls _data/language_detail/ 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Nucleo Pages: $(ls waw/evolution/nucleo/*.md 2>/dev/null | wc -l) pages" >> $GITHUB_STEP_SUMMARY
          echo "- Language Pages: $(ls waw/evolution/language/*.md 2>/dev/null | wc -l) pages" >> $GITHUB_STEP_SUMMARY
