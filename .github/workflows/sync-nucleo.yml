name: Sync Nucleo Evolution Data

on:
  schedule:
    # Ogni 6 ore
    - cron: '0 */6 * * *'
  
  # Manuale on-demand
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create data directories
        run: |
          mkdir -p _data/expression_detail
          mkdir -p _data/nucleus_overview
          mkdir -p _data/language_detail
          echo "ðŸ“ Directories created"
      
      - name: Fetch Dashboard
        run: |
          echo "ðŸ“¥ Fetching dashboard..."
          curl -f -v https://log-puck.org/nucleo/nucleo_publish/dashboard.json \
               -o _data/evolution_dashboard.json
          
          echo "âœ… Dashboard downloaded"
          ls -lh _data/evolution_dashboard.json
          echo "Preview:"
          head -n 10 _data/evolution_dashboard.json
      
      - name: Fetch Nucleus Overview
        run: |
          echo "ðŸ“¥ Fetching nucleus overview..."
          
          # Get list of nuclei from dashboard
          jq -r '.summary.nuclei[]' _data/evolution_dashboard.json | while IFS= read -r nucleus; do
            echo "  â†’ ${nucleus}"
            
            if curl -f "https://log-puck.org/nucleo/nucleo_publish/nucleus/${nucleus}.json" \
                    -o "_data/nucleus_overview/${nucleus}.json" 2>/dev/null; then
              echo "    âœ… Success"
            else
              echo "    âŒ Failed"
            fi
          done
          
          echo "Files downloaded:"
          ls -lh _data/nucleus_overview/ 2>/dev/null || echo "  (none)"
      
      - name: Fetch Expression Details
        run: |
          echo "ðŸ“¥ Fetching expression details..."
          
          # Get list of expressions from dashboard
          jq -r '.by_nucleo[].nucleo_id[]' _data/evolution_dashboard.json | while IFS= read -r expr_id; do
            echo "  â†’ ${expr_id}"
            
            if curl -f "https://log-puck.org/nucleo/nucleo_publish/expressions/${expr_id}.json" \
                    -o "_data/expression_detail/${expr_id}.json" 2>/dev/null; then
              echo "    âœ… Success"
            else
              echo "    âŒ Failed"
            fi
          done
          
          echo "Files downloaded:"
          ls -lh _data/expression_detail/ 2>/dev/null || echo "  (none)"
      
      - name: Fetch Language Details
        run: |
          echo "ðŸ“¥ Fetching language details..."
          
          # Fetch each language detail using while read to preserve spaces
          jq -r '.summary.languages[]' _data/evolution_dashboard.json | while IFS= read -r lang; do
            # Sanitize for filename
            lang_sanitized=$(echo "$lang" | sed 's/ /_/g' | tr '[:upper:]' '[:lower:]')
            
            echo "  â†’ '$lang' â†’ ${lang_sanitized}.json"
            
            # Try downloading with sanitized name first
            if curl -f "https://log-puck.org/nucleo/nucleo_publish/language/${lang_sanitized}.json" \
                    -o "_data/language_detail/${lang_sanitized}.json" 2>/dev/null; then
              echo "    âœ… Success (sanitized URL)"
            # If that fails, try with original name and save as sanitized
            elif curl -f "https://log-puck.org/nucleo/nucleo_publish/language/${lang}.json" \
                    -o "_data/language_detail/${lang_sanitized}.json" 2>/dev/null; then
              echo "    âœ… Success (original URL)"
            else
              echo "    âŒ Failed both attempts"
            fi
          done
          
          echo "Files downloaded:"
          ls -lh _data/language_detail/ 2>/dev/null || echo "  (none)"
      
      - name: Check git status
        run: |
          echo "ðŸ“Š Git status:"
          git status
          
          echo ""
          echo "ðŸ“ Changed files:"
          git status --short
      
      - name: Generate Nucleus pages (OB-AI)
        run: |
          echo "ðŸ‘¤ Generating nucleus profile pages..."
          
          # Create ob-ai directory if not exists
          mkdir -p ob-ai
          
          # Remove old Einstein placeholder if exists
          rm -f ob-ai/einstein.md
          
          # Get list of nuclei from dashboard
          jq -r '.summary.nuclei[]' _data/evolution_dashboard.json | while IFS= read -r nucleus; do
            # Get display_name from nucleus JSON
            display_name=$(jq -r '.display_name // "Unknown"' "_data/nucleus_overview/${nucleus}.json" 2>/dev/null || echo "Unknown")
            
            echo "  â†’ Creating ob-ai/${nucleus}.md (${display_name})"
            
            # Write frontmatter using printf (safer than here-document in YAML)
            printf '%s\n' \
              "---" \
              "layout: nucleus_profile" \
              "nucleus: ${nucleus}" \
              "section: OB-AI" \
              "permalink: /ob-ai/${nucleus}/" \
              "title: \"${display_name}\"" \
              "---" \
              > "ob-ai/${nucleus}.md"
          done
          
          # Count generated files
          FILE_COUNT=$(ls -1 ob-ai/nucleo_*.md 2>/dev/null | wc -l)
          echo "âœ… Generated ${FILE_COUNT} nucleus pages"
          
          # List generated files for verification
          echo "Files created:"
          ls -1 ob-ai/nucleo_*.md 2>/dev/null || echo "  (none)"
      
      - name: Generate Expression pages (wAw/Evolution)
        run: |
          echo "ðŸ”¬ Generating expression pages..."
          
          # Create evolution/expressions directory if not exists
          mkdir -p waw/evolution/expressions
          
          # Clean up old generated files in nucleo/ directory
          echo "Cleaning up old nucleo/ files..."
          rm -rf waw/evolution/nucleo
          
          # Clean up old generated files in expressions/ (keep .gitkeep and _*.md test files)
          echo "Cleaning up old expression files..."
          find waw/evolution/expressions -type f -name "*.md" ! -name "_*.md" -delete 2>/dev/null || true
          
          # Get list of expressions from dashboard
          jq -r '.by_nucleo[].nucleo_id[]' _data/evolution_dashboard.json | while IFS= read -r expr_id; do
            # Get nucleus from expression JSON
            nucleus=$(jq -r '.nucleus // "unknown"' "_data/expression_detail/${expr_id}.json" 2>/dev/null || echo "unknown")
            
            echo "  â†’ Creating waw/evolution/expressions/${expr_id}.md (nucleus: ${nucleus})"
            
            # Write frontmatter using printf (safer than here-document in YAML)
            printf '%s\n' \
              "---" \
              "layout: expression_detail" \
              "expression_id: ${expr_id}" \
              "nucleus: ${nucleus}" \
              "section: wAw" \
              "subsection: Evolution" \
              "permalink: /waw/evolution/expressions/${expr_id}/" \
              "title: \"${expr_id}\"" \
              "---" \
              > "waw/evolution/expressions/${expr_id}.md"
          done
          
          # Count generated files
          FILE_COUNT=$(ls -1 waw/evolution/expressions/*.md 2>/dev/null | wc -l)
          echo "âœ… Generated ${FILE_COUNT} expression pages"
          
          # List generated files for verification
          echo "Files created:"
          ls -1 waw/evolution/expressions/*.md 2>/dev/null || echo "  (none)"
      
      - name: Generate Language pages
        run: |
          echo "ðŸ—£ï¸ Generating language markdown files..."
          
          # Create evolution/language directory if not exists
          mkdir -p waw/evolution/language
          
          # Clean up old generated files (keep .gitkeep and _*.md test files)
          echo "Cleaning up old generated files..."
          find waw/evolution/language -type f -name "*.md" ! -name "_*.md" -delete 2>/dev/null || true
          
          # Generate .md file for each language using while read to preserve spaces
          jq -r '.summary.languages[]' _data/evolution_dashboard.json | while IFS= read -r lang; do
            # Sanitize language name for filename (lowercase, spaces to underscores)
            lang_key=$(echo "$lang" | sed 's/ /_/g' | tr '[:upper:]' '[:lower:]')
            
            echo "  â†’ Creating waw/evolution/language/${lang_key}.md (from: '$lang')"
            
            # Write frontmatter using printf (safer than here-document in YAML)
            printf '%s\n' \
              "---" \
              "layout: language_detail" \
              "language_key: ${lang_key}" \
              "section: wAw" \
              "subsection: Evolution" \
              "permalink: /waw/evolution/language/${lang_key}/" \
              "title: \"${lang}\"" \
              "---" \
              > "waw/evolution/language/${lang_key}.md"
          done
          
          # Count generated files
          FILE_COUNT=$(ls -1 waw/evolution/language/*.md 2>/dev/null | wc -l)
          echo "âœ… Generated ${FILE_COUNT} language pages"
          
          # List generated files for verification
          echo "Files created:"
          ls -1 waw/evolution/language/*.md 2>/dev/null || echo "  (none)"
      
      - name: Commit and push
        run: |
          git config user.name "Nucleo Sync Bot"
          git config user.email "nucleo@log-puck.org"
          
          # Add all files (new and modified)
          git add _data/evolution_dashboard.json
          git add _data/expression_detail/
          git add _data/nucleus_overview/
          git add _data/language_detail/
          git add ob-ai/
          git add waw/evolution/expressions/
          git add waw/evolution/language/
          
          # Stage removal of old nucleo/ directory if it exists
          git add -A waw/evolution/nucleo/ 2>/dev/null || true
          
          # Check if there's anything to commit
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ðŸ”¬ Nucleus migration - Evolution data sync - ${TIMESTAMP}"
            git push
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Summary
        run: |
          echo "### ðŸ”¬ Nucleus Evolution Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_data/evolution_dashboard.json" ]; then
            TOTAL=$(jq -r '.summary.total_experiments // 0' _data/evolution_dashboard.json)
            NUCLEI=$(jq -r '.summary.nuclei | length' _data/evolution_dashboard.json 2>/dev/null || echo "0")
            EXPRESSIONS=$(jq -r '.by_nucleo[].nucleo_id | length' _data/evolution_dashboard.json 2>/dev/null || echo "0")
            echo "**Total Experiments:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "**Nuclei:** $NUCLEI" >> $GITHUB_STEP_SUMMARY
            echo "**Expressions:** $EXPRESSIONS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files synced:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Nucleus Profiles: $(ls _data/nucleus_overview/ 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Expression Details: $(ls _data/expression_detail/ 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Language Details: $(ls _data/language_detail/ 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pages generated:**" >> $GITHUB_STEP_SUMMARY
          echo "- Nucleus Pages (OB-AI): $(ls ob-ai/nucleo_*.md 2>/dev/null | wc -l) pages" >> $GITHUB_STEP_SUMMARY
          echo "- Expression Pages (Evolution): $(ls waw/evolution/expressions/*.md 2>/dev/null | wc -l) pages" >> $GITHUB_STEP_SUMMARY
          echo "- Language Pages (Evolution): $(ls waw/evolution/language/*.md 2>/dev/null | wc -l) pages" >> $GITHUB_STEP_SUMMARY
